# MySQL笔记

## 体系结构

![image-20221201205510941](MySQL笔记.assets/image-20221201205510941.png)

### 连接层

负责存储和管理客户端与数据库的连接，并完成授权认证等。采用连接池的方式，一个线程负责管理一个连接。

### 服务层

系统管理和控制工具（Management Services & Utilities）：例如备份恢复、安全管理、集群管理等。
SQL接口（SQL Interface）：用于接受客户端发送的各种SQL命令，并且返回用户需要查询的结果。比如DML、DDL、存储过程、视图、触发器等。
解析器（Parser）：负责将请求的SQL解析生成一个"解析树"。然后根据一些MySQL规则进一步检查解析树是否合法。
查询优化器（Optimizer）：当“解析树”通过解析器语法检查后，将交由优化器将其转化成执行计划，然后与存储引擎交互。

### 存储引擎层

存储引擎负责MySQL中数据的存储与提取，与底层系统文件进行交互。MySQL存储引擎是插件式的，服务器中的查询执行引擎通过接口与存储引擎进行通信，接口屏蔽了不同存储引擎之间的差异 。现在有很多种存储引擎，各有各的特点，最常见的是MyISAM和InnoDB。

### 存储层

该层负责将数据库的数据和日志存储在文件系统之上，并完成与存储引擎的交互，是文件的物理存储层。主要包含日志文件，数据文件，配置文件，pid 文件，socket 文件等。

## 存储引擎

常用的存储引擎主要有MyISAM和InnoDB两种，Mysql默认使用InnoDB存储引擎。

### 存储引擎对比

| 存储引擎 | 主外键 | 事务   | 行表锁                                           | 存储                           | 表空间 | 关注点 | 默认安装 |
| -------- | ------ | ------ | ------------------------------------------------ | ------------------------------ | ------ | ------ | -------- |
| MyISAM   | 不支持 | 不支持 | 表锁，操作一条记录会锁住整个表，不适合高并发操作 | 只缓存索引                     | 小     | 读性能 | 是       |
| InnoDB   | 支持   | 支持   | 行锁，操作只锁某一行，适合高并发操作             | 缓存索引和真实数据，需要内存多 | 大     | 事务   | 是       |

### 数据文件

InnoDB存储引擎：

- frm文件 -  存放表结构

- idb文件 - 存放表数据和索引

MyISAM存储引擎：

- frm文件 - 存放表结构
- myd文件 - 存放表数据
- myi文件 - 存放表索引

## 配置文件

mysql 的配置文件在Windows操作系统系统下叫`my.ini`，在Linux下是`/etc/my.cnf`

## 事务

### 事务特性

事务的四大特性分别是：原子性、一致性、隔离性、持久性。

1. 原子性：指事务是一个不可分割的工作单位，事务中的操作要么全部成功，要么全部失败。

2. 一致性：事务必须使数据库从一个一致性状态变换到另外一个一致性状态。如张三给李四转账100，张三要减少100，李四就要加上100。

3. 隔离性：多个事务并发操作数据时，一个事务不能被其他事务操作数据所干扰，多个并发事务之间要相互隔离。

4. 持久性：一个事务一旦被提交，它对数据库中数据的改变就是永久性的。

### 事务并发可能出现的问题

- 脏读（Dirty Read）：A事务读到了B事务未提交修改的数据。因为B有可能会回滚。
- 不可重复读（Non-Repeatable Read）：A事务两次读取同一个数据，得到的结果不一样。因为有可能被B事务修改并提交了。
- 幻读（Phantom）：A事务按照条件查询数据，这时候B事务插入了一条新数据，A事务再查数据时把B事务新插入的数据也查了出来。

### 事务隔离级别

MySQL的事务隔离级别一共有四个，分别是读未提交、读已提交、可重复读以及可串行化。

1. 读未提交（Read Uncommitted）：允许在事务中读到其他事务未提交的数据，可能导致脏读。当然还有不可重复读和幻读。一般很少使用此隔离级别。

2. 读已提交（Read Committed）：允许在事务中读到其他事务已经提交的数据，解决了脏读，但是可能导致不可重复读，当然还有幻读。一般很少使用此隔离级别。
3. 可重复度（Repeatable Read）- 默认：事务A只能在事务B修改过数据并提交后，自己也提交事务后，才能读取到事务A修改的数据；但是未提交时可以读到B新增的数据。解决了不可重复读，但是可能会有幻读的问题（不过InnoDB引擎的MVCC已经解决了幻读的问题）。

4. 可串行化（Serializable）：事务串行执行，通过锁实现，效率低。一般不会使用

4种事务隔离级别的对比：

|          | 脏读 | 不可重复读读 | 幻读 |
| :------: | :--: | :----------: | :--: |
| 读未提交 | 可能 |     可能     | 可能 |
| 读已提交 | 不会 |     可能     | 可能 |
| 可重复读 | 不会 |     不会     | 可能 |
| 可串行化 | 不会 |     不会     | 不会 |

### 事务隔离级别查询与设置

查看当前数据库事务隔离级别。

```sql
SELECT @@transaction_isolation
```

设置事务隔离级别

```sql
-- 全局设置 只对执行完该语句之后产生的会话起作用
SET GLOBAL TRANSACTION ISOLATION LEVEL level;
-- 当前会话 对当前会话的所有后续的事务有效，不影响正在执行的事务
SET SESSION TRANSACTION ISOLATION LEVEL level;
-- 当前会话的下一个事务
SET TRANSACTION ISOLATION LEVEL level;
```



