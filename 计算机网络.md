### 网络分层结构

为了提高网络的可管理性、可扩展性和稳定性，网络通常采用分层结构设计。

#### 1.核心层（Core Layer）

- **功能与作用**：
   核心层是整个网络的高速骨干，负责在各个分支或区域之间传递大量数据。它要求具有极高的吞吐量和可靠性，通常实现高速交换与路由。
- **特点**：
  - 高性能、低延迟
  - 强冗余设计，确保网络中断时能迅速恢复
  - 负责跨越不同区域的高速数据传输


#### 2. 汇聚层/分布层（Distribution/Aggregation Layer）

- **功能与作用**：
   汇聚层位于核心层与接入层之间，主要负责数据包的汇聚、过滤和策略控制。它在不同接入层之间提供连接，同时实现网络安全策略、访问控制和负载均衡等功能。
- **特点**：
  - 提供路由和策略实施（如访问控制、流量整形、防火墙功能等）
  - 连接不同的接入层设备，并汇聚流量传递到核心层
  - 可以作为区域间的分界点，对流量进行优化和管理


#### 3. 接入层（Access Layer）

- **功能与作用**：
   接入层是最终用户或终端设备（如PC、打印机、IP电话等）所在的网络边缘。它主要负责将终端设备接入网络，提供用户认证、安全策略以及基础的数据传输。
- **特点**：
  - 支持大量用户和设备接入
  - 提供局部的网络服务，如VLAN划分、PoE供电等
  - 集中管理接入设备，便于监控和故障排查


#### 附加说明

- **层次设计优势**：
  - **模块化管理**：各层职责分明，便于扩展和维护。
  - **故障隔离**：问题可以在具体的层次上定位，降低整个网络的故障风险。
  - **性能优化**：通过在汇聚层实现策略控制和流量优化，能更有效地使用核心资源。
- **实际部署中的变体**：
  - 在一些中小型网络中，核心层和汇聚层可能合并为“汇聚核心层”或“坍塌核心”设计。
  - 数据中心、广域网等场景可能会有更复杂的分层设计，增加安全隔离层、边缘层等。



### CIDR

CIDR（无类别域间路由，Classless Inter-Domain Routing）是一种用于分配IP地址和进行IP路由的网络方法。CIDR取代了旧的基于类的IP地址方法（A类、B类、C类网络），它提供了更灵活的IP地址划分和更高效的路由。

#### CIDR表示法

CIDR表示法使用IP地址和一个斜杠后跟一个数字来表示网络。这个数字表示网络前缀的长度，也就是网络部分的位数。形式如下：

```
<IP地址>/<网络前缀长度>
```

例如：

- `192.168.1.0/24` 表示从 `192.168.1.0` 到 `192.168.1.255` 的所有地址（256个地址），其中前24位是网络部分。
- `10.0.0.0/8` 表示从 `10.0.0.0` 到 `10.255.255.255` 的所有地址（16,777,216个地址），其中前8位是网络部分。

#### 如何工作

在CIDR中，网络前缀长度定义了网络部分和主机部分的边界：

- 网络部分用于标识网络。
- 主机部分用于标识网络中的特定设备。

例如，考虑以下CIDR网段：

- `192.168.1.0/24`

`/24` 表示网络前缀长度是24位，所以网络部分是 `192.168.1`，主机部分是 `0` 到 `255`。这意味着这个网络可以容纳256个IP地址（从 `192.168.1.0` 到 `192.168.1.255`）。

> 除去前缀长度，剩余的位数就是控制ip地址的变化范围。表示的ip地址范围就是从给定的网络开始，到能表示最大的ip地址结束。

#### 优点

1. **灵活性**：CIDR允许更灵活的网络划分，可以根据需要分配任意大小的子网，而不受A类、B类、C类网络的限制。
2. **地址节省**：通过更有效的地址分配，CIDR可以减少IP地址的浪费，特别是在IPv4地址资源有限的情况下。
3. **简化路由表**：CIDR通过聚合路由（路由汇总），可以减少路由表的大小，降低路由器的工作量。

#### 示例

假设你有一个网络 `192.168.1.0/24`，你可以将其划分为两个子网：

- `192.168.1.0/25`：包含 `192.168.1.0` 到 `192.168.1.127` 的IP地址
- `192.168.1.128/25`：包含 `192.168.1.128` 到 `192.168.1.255` 的IP地址

这种方式使得网络划分更加灵活，可以根据实际需求进行精细化管理。

#### 总结

CIDR是现代IP地址分配和路由的基础，它通过使用网络前缀长度来提供更灵活和高效的网络划分方法。它取代了旧的基于类的IP地址分配方法，解决了很多早期IP网络中的问题。



### 为访问的 IP 指定网卡(改路由表)

当我们有两个网卡同时启用时，操作系统会选择一个默认网卡来路由网络流量，但是这样有时候会因为默认网关无法访问到指定的ip，导致我们的机器就无法访问该IP了。

如果我们想通过特定的网卡来访问特定的地址，例如使用B网卡访问x网址，而其他流量通过A网卡，可以通过修改路由表来解决，让指定的IP走指定的网关。

#### **Windows 系统**:

1. **打开命令提示符** (以管理员身份运行)。

2. **查看当前的路由表**:

   ```bash
   route print
   ```

3. **添加静态路由**: 假设你想通过B网卡（无线网络）访问x地址，并且B网卡的网关IP是`192.168.1.1`，你可以使用以下命令：

   ```bash
   route add x.x.x.x mask 255.255.255.255 192.168.1.1
   ```

   其中，`x.x.x.x`是你要访问的目标地址，`255.255.255.255`表示一个单一的IP地址，`192.168.1.1`是B网卡的网关地址。

4. **验证路由**: 再次使用`route print`查看路由表，确认新添加的路由是否存在。

5. **永久保存路由**: 如果你希望这个路由在系统重启后仍然有效，可以加上`-p`参数：

   ```bash
   route -p add x.x.x.x mask 255.255.255.255 192.168.1.1
   ```

#### **Linux 系统**:

1. **查看网卡信息**: 使用以下命令查看网卡信息：

   ```bash
   ip addr show
   ```

2. **添加路由**: 假设B网卡的接口名是`wlan0`，你可以使用以下命令：

   ```bash
   ip route add x.x.x.x/32 via 192.168.1.1 dev wlan0
   ```

   其中，`/32`表示一个单一的IP地址。

3. **查看路由表**: 使用以下命令查看路由表：

   ```bash
   ip route show
   ```

4. **永久保存路由**: 可以将该命令添加到系统启动脚本中，确保系统重启后仍然有效。



### 路由跟踪

当你要访问`baidu.com`的时候，网络请求的数据包并不会直接从你的本地网络跳到目标服务器，而是需要经过多个中间节点。

这是因为互联网的架构是分布式的，数据传输依赖于多个路由器和网络运营商的协作。这是因为网络是复杂的

#### 网络路为什么不是两点一线

##### 1 网络分层结构

- 本地网络（LAN）你的数据包首先从你的计算机经过本地路由器（如 10.3.27.254），这是你的网关。
- 运营商网络（ISP）：进入你的互联网服务提供商（ISP）的网络后，数据包会被转发到 ISP 的多个路由器。
- 骨干网络：ISP 通常会将流量传输到更大的骨干网络，这些网络由多个运营商（如中国移动、中国电信、中国联通等）互联组成。
- 目标网络：最后，数据包到达 baidu.com 所在的服务器网络（百度自己的数据中心或其托管网络）。

跃点数量多，说明数据包经过了本地网络、ISP 网络和骨干网络的多个节点。

##### 2 路由选择

- 互联网上的路由并不是直线距离，而是由 **路由协议（如 BGP，边界网关协议）** 动态决定的。
- 路由器根据实时的网络状况（如延迟、带宽、拥堵情况）选择“最佳路径”，而不是“最短路径”。
- 即使 baidu.com 是国内地址，你的 ISP 和百度的服务器可能位于不同的城市或网络区域，因此需要经过多个节点中转。

##### 3 运营商之间的互联

- 在国内，不同运营商（如电信、联通、移动）的网络并非完全直连，可能需要通过中转节点（称为 **IXP，互联网交换点**）进行数据交换。
- 例如，如果你的 ISP 是中国电信，而 baidu.com 的服务器接入的是中国移动，数据包可能需要经过多个路由器才能跨越运营商网络

#### 查看网络请求路径

Traceroute（路由跟踪）一般通过`ICMP`（ping命令也使用该协）协议来实现网络路径查看。

##### Traceroute（路由跟踪）的基本原理

**目的**：tracert（在Windows中）用于探测数据包从本机到目标主机（如 baidu.com）的经过路径以及每一跳（跃点）的响应时间。

**原理**：它通过设置数据包的 TTL（Time To Live，生存时间）值来实现。TTL值在每经过一个路由器时会减一，当TTL为0时，路由器会丢弃该数据包并返回一个ICMP“超时”消息。通过依次增大TTL值，tracert能够显示经过的每一台路由器及其响应时间。

> 路由跟踪一般最多会尝试30跳的路径，如果超过这个数量，程序会停止跟踪。
>
> 每一行代表一次TTL设置对应的“跃点”，通常包含3次尝试的响应时间。
>
> - 跃点序号：例如第1行表示第1跳、第2行表示第2跳，以此类推。
> - 响应时间：例如第1跳显示“1 ms 1 ms <1 毫秒”，表示三次发送的数据包分别返回的时间（毫秒为单位）。有时会用“<1 毫秒”表示响应时间非常短，一般在网关中，最后一跳的时间代表的是本机到该节点的时间。
> - IP地址或域名：每一行最后的部分显示了该跃点对应的路由器IP地址，有时也可能显示域名。比如第1跳显示“10.3.27.254”，说明该路由器在局域网中或运营商内部。
> - 请求超时（\*）：如果某次尝试没有收到响应，就会显示“*”或“请求超时”。这可能是因为该路由器配置不返回ICMP消息，或者数据包在传输过程中丢失了响应信息。但是一般不影响数据包的传递。

#### Windows路由跟踪

在windows操作系统中，自带了`tracert`命令，执行命令`tracert baidu.com`即可查看本机到目标服务器的网络路径。示例如下：

```bash
C:\Users\15718>tracert baidu.com

通过最多 30 个跃点跟踪
到 baidu.com [39.156.66.10] 的路由:

  1     1 ms    <1 毫秒    1 ms  10.3.27.254
  2     *        *        *     请求超时。
  3     2 ms     3 ms     3 ms  223.68.184.65
  4     *        *        *     请求超时。
  5     *        *        *     请求超时。
  6     *        *        *     请求超时。
  7    80 ms    24 ms    24 ms  221.183.53.178
  8    27 ms     *       28 ms  39.156.27.5
  9    26 ms    22 ms    22 ms  39.156.67.17
 10     *        *        *     请求超时。
 11     *        *        *     请求超时。
 12     *        *        *     请求超时。
 13    26 ms    25 ms    25 ms  39.156.66.10

跟踪完成。
```

经过了13跳才到达目的地址。网速正常，3次测试响应时间差不多，网络稳定。

#### Linux路由跟踪

Linux一般默认没有`traceroute`命令程序的，需要手动安装。如Centos执行命令`yum install traceroute`或者`dnf install traceroute`

还有需要注意的是，linux中如果执行`traceroute baidu.com`，traceroute 默认使用 UDP 协议，可能被某些路由器或防火墙阻挡，导致更多超时。可以通过增加参数 `-I`  指定 ICMP 模式运行 traceroute。

```bash
traceroute -I baidu.com # ICMP 协议路由跟踪，等同 windows系统: tracert baidu.com
```



### Http协议

#### 响应头

**Content-Length：**设置响应体长度，值为数值类型。客户端会不断接收数据直到长度和`Content-Length`的值相等，如果值比真实长度小，内容可能会被客户端截断（ApiPost），如果比真实长度大，客户端将会一直等待数据，比如浏览器标签页一直在转圈。

**Transfer-Encoding：**设置数据传输编码，常用值为`chunked`，表示数据分块传输，如果响应的长度不确定，可以使用这个响应头。HTTP/2 **不支持 `Transfer-Encoding: chunked`**，它有自己更高效的 **流式传输** 机制，所有数据都以 **帧（frames）** 形式传输，客户端不需要 `Content-Length` 也能正确解析数据。HTTP 规范（RFC 7230, Section 3.3.3）明确规定，如果两者同时存在，客户端必须**忽略 `Content-Length`**，否则可能会导致 HTTP 解析漏洞（例如 HTTP Request Smuggling 攻击）。

